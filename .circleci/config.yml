# This file was generated by the excavator check 'excavator/manage-circleci' as specified in .circleci/template.sh.
# To request a modification to the general template, file an issue on Excavator.
# To manually manage the CircleCI configuration for this project, remove the .circleci/template.sh file.

version: 2.1

orbs:
  go: palantir/go@0.0.29
  godel: palantir/godel@0.0.29

homepath: &homepath
  homepath: /home/circleci

gopath: &gopath
  gopath: /home/circleci/go

working_directory: &working_directory
    working_directory: /home/circleci/go/src/github.com/palantir/log4j-sniffer

executors:
  circleci-go:
    docker:
      - image: cimg/go:1.16-browsers
    <<: *working_directory

all-tags-filter: &all-tags-filter
  filters:
    tags:
      only: /.*/

jobs:
  dist:
    executor: circleci-go
    steps:
      - checkout
      - run: mkdir -p ./out/dist/log4j-sniffer/$(./godelw project-version)/os-arch-bin/log4j-sniffer-$(./godelw project-version)/linux-amd64
      - run: mkdir -p ./out/dist/log4j-sniffer/$(./godelw project-version)/os-arch-bin/log4j-sniffer-$(./godelw project-version)/linux-arm64
      - run: mkdir -p ./out/dist/log4j-sniffer/$(./godelw project-version)/os-arch-bin/log4j-sniffer-$(./godelw project-version)/darwin-amd64
      - run: mkdir -p ./out/dist/log4j-sniffer/$(./godelw project-version)/os-arch-bin/log4j-sniffer-$(./godelw project-version)/darwin-arm64
      - run: mkdir -p ./out/dist/log4j-sniffer/$(./godelw project-version)/os-arch-bin/log4j-sniffer-$(./godelw project-version)/windows-amd64
      - run: GOFLAGS="-mod=vendor" CGO_ENABLED="1" GOOS=linux   GOARCH=amd64 go build -ldflags "-X github.com/palantir/log4j-sniffer/cmd.Version=$(./godelw project-version)" -o ./out/dist/log4j-sniffer/$(./godelw project-version)/os-arch-bin/log4j-sniffer-$(./godelw project-version)/linux-amd64/log4j-sniffer .
      - run: GOFLAGS="-mod=vendor"                 GOOS=linux   GOARCH=arm64 go build -ldflags "-X github.com/palantir/log4j-sniffer/cmd.Version=$(./godelw project-version)" -o ./out/dist/log4j-sniffer/$(./godelw project-version)/os-arch-bin/log4j-sniffer-$(./godelw project-version)/linux-arm64/log4j-sniffer .
      - run: GOFLAGS="-mod=vendor"                 GOOS=darwin  GOARCH=amd64 go build -ldflags "-X github.com/palantir/log4j-sniffer/cmd.Version=$(./godelw project-version)" -o ./out/dist/log4j-sniffer/$(./godelw project-version)/os-arch-bin/log4j-sniffer-$(./godelw project-version)/darwin-amd64/log4j-sniffer .
      - run: GOFLAGS="-mod=vendor"                 GOOS=darwin  GOARCH=arm64 go build -ldflags "-X github.com/palantir/log4j-sniffer/cmd.Version=$(./godelw project-version)" -o ./out/dist/log4j-sniffer/$(./godelw project-version)/os-arch-bin/log4j-sniffer-$(./godelw project-version)/darwin-arm64/log4j-sniffer .
      - run: GOFLAGS="-mod=vendor"                 GOOS=windows GOARCH=amd64 go build -ldflags "-X github.com/palantir/log4j-sniffer/cmd.Version=$(./godelw project-version)" -o ./out/dist/log4j-sniffer/$(./godelw project-version)/os-arch-bin/log4j-sniffer-$(./godelw project-version)/windows-amd64/log4j-sniffer.exe .
      - run: tar -C ./out/dist/log4j-sniffer/$(./godelw project-version)/os-arch-bin/log4j-sniffer-$(./godelw project-version)/linux-amd64 -zcvf ./out/dist/log4j-sniffer/$(./godelw project-version)/os-arch-bin/log4j-sniffer-$(./godelw project-version)-linux-amd64.tgz log4j-sniffer
      - run: tar -C ./out/dist/log4j-sniffer/$(./godelw project-version)/os-arch-bin/log4j-sniffer-$(./godelw project-version)/linux-arm64 -zcvf ./out/dist/log4j-sniffer/$(./godelw project-version)/os-arch-bin/log4j-sniffer-$(./godelw project-version)-linux-arm64.tgz log4j-sniffer
      - run: tar -C ./out/dist/log4j-sniffer/$(./godelw project-version)/os-arch-bin/log4j-sniffer-$(./godelw project-version)/darwin-amd64 -zcvf ./out/dist/log4j-sniffer/$(./godelw project-version)/os-arch-bin/log4j-sniffer-$(./godelw project-version)-darwin-amd64.tgz log4j-sniffer
      - run: tar -C ./out/dist/log4j-sniffer/$(./godelw project-version)/os-arch-bin/log4j-sniffer-$(./godelw project-version)/darwin-arm64 -zcvf ./out/dist/log4j-sniffer/$(./godelw project-version)/os-arch-bin/log4j-sniffer-$(./godelw project-version)-darwin-arm64.tgz log4j-sniffer
      - run: tar -C ./out/dist/log4j-sniffer/$(./godelw project-version)/os-arch-bin/log4j-sniffer-$(./godelw project-version)/windows-amd64 -zcvf ./out/dist/log4j-sniffer/$(./godelw project-version)/os-arch-bin/log4j-sniffer-$(./godelw project-version)-windows-amd64.tgz log4j-sniffer.exe
      - save_cache:
          key: dist-{{ .Environment.CIRCLE_WORKFLOW_ID }}-{{ .Environment.CIRCLE_SHA1 }}-v1
          paths:
            - out

workflows:
  version: 2
  verify-test-dist-publish:
    jobs:
      - godel/verify:
          name: verify
          executor: circleci-go
          <<: *homepath
          <<: *gopath
          <<: *all-tags-filter
      - godel/test:
          name: test
          executor: circleci-go
          <<: *homepath
          <<: *gopath
          <<: *all-tags-filter
      - dist:
          name: dist
          <<: *all-tags-filter
